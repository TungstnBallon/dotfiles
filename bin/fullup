#!/usr/bin/env bash

first=true

function section() {
	if [ $first = true ]; then
		first=false
		printf "\e[2m---* %s *---\e[0m\n" "$1"
	else
		printf "\n\e[2m---* %s *---\e[0m\n" "$1"
	fi
}

section "System & AUR packages"
paru -Syu --noconfirm
if [ -f /tmp/NVIM_COMMIT ]; then
	xdg-open "https://github.com/neovim/neovim/compare/$(cat /tmp/NVIM_COMMIT)...HEAD"
	sudo rm /tmp/NVIM_COMMIT
fi

section Flatpak
flatpak update -y
flatpak remove --unused -y
flatpak remove --delete-data -y

section Rust
rustup update

section Dotfiles
git -C "$HOME/.dotfiles" pull

section "Zinit & Zsh plugins"
zsh -c "source $HOME/.zshrc && zinit update -p"

section Prompt
(
	cd "$HOME/.dotfiles/terminal/prompt" || return
	cargo install --path .
)

section "Neovim plugins"
nvim_pack_log_file="$(nvim --headless "+echo stdpath('log')" +q 2>&1)/nvim-pack.log"
nvim --headless +PackUpdate! +q 2>/dev/null
# File's line in reverse order
tac "${nvim_pack_log_file}" |
	# Print lines up until the marker
	sed -n "/======/q;p" |
	# Trim empty starting lines
	awk NF |
	# Reverse lines back to original order
	tac |
	# Trim empty starting lines
	awk NF
